.TH "FRANz"
.SH NAME
FRANz \- Pedigree reconstruction.
.SH VERSION
1.2.3
.SH SYNOPSIS
.B FRANz 
[Options] 
.I infile
.SH DESCRIPTION
FRANz reconstructs pedigrees (family trees) using polymorphic, codominant markers.
.SH OPTIONS
.B Prior Information:
.TP
.B --femrepro \fIi\^:\fIi
Age range in which females can reproduce (default 0:1000).
.TP
.B --malerepro \fIi\^:\fIi
Age range in which males can reproduce (default 0:1000). For individuals with
unknown sex, the maximum age range is used. For example,
.IP ""
.B --femrepro  \fI13\^:\fI43 
.B --malerepro \fI14\^:\fI60
.IP ""
here, individuals with unknown sex are not excluded from age 13 to 60 as
candidate parents. 
.TP
.BI --N " i " [ --Nf " i " --Nm " i" ]
For paternity inference, N is the number of candidate fathers in the
population (default auto) [NMCP01]. This is the sum of the average number of
sampled (n) and unsampled (N-n) breeding males in the population. If unset,
then estimated jointly with the pedigree. For parentage inference N = Nf = Nm
(NOT Nf + Nm), but one can also specify Nf and Nm instead of N if these
numbers differ. If N is not known, use Nmax instead.
.TP
.BI --Nmax " i " [  --Nfmax " i " --Nmmax " i" ] 
Maximum number of candidate fathers in the population. This is the estimated
upper limit of N when N is not known. FRANz will then incorporate the
uncertainity of N in the pedigree reconstruction. We need this limit to avoid
that the Markov Chain converges to a very high N, which would result in an
empty pedigree. When mothers are unknown and the numbers of males and females
differ, we can again specify Nfmax and Nmmax. 
.TP
.BI --n " i"
Number of sampled candidate parents (default auto) [NMCP01]. This feature can
be used in combination with --N for setting the number of unsampled candidates
(N-n) directly (which might be useful in the absence of age data). 
.TP
.BI --pedigreein " FILE"
Filename of the pedigree input file.
.TP
.BI --fullsibin " FILE"
Filename of the fullsib input file. 
.TP
.BI --halfsibin " FILE"
Filename of the halfsib input file. Individuals that are fullsibs OR
halfsibs (e.g. for nest structured data). EXPERIMENTAL FEATURE.
.TP
.BI --geofile " FILE"
Pairwise distances of sampling locations.
.TP
.BI --coordfile " FILE"
Coordinates of sampling locations.
.PP
.B Parentage Options:
.TP
.B --selfing            
Allows selfing. 
.TP
.BI --mintyped " i"
Minimum number of typed loci (default 1+numloci/2). Individuals with less typed loci
will be ignored. This number also defines the minimum number of common
typed loci for a pair of individuals.
.TP
.BI --maxmismatching " i,i"
Maximum number of mismatching loci for pairs and triples. If unset, then the
mismatch distributions generated by the simulation are used to calculate this
values. This procedure strongly depends on the estimated typing error rate.
.TP
.BI --numloci " i" 
Use only the first i loci. For testing purposes mainly.
.TP
.BI --typingerror " f"
Rate of typing error. If some parent-offspring relationships are known (with
--pedigreein), then the observed mismatches in these relationships are used to
estimate the typing error. The minimum number of relationships is calculated
with the standard statistical methods (z=1.96, 20% accepted error). If the
observed number is too low, we assume that the error rate is constant across
loci and devide the required number by the number of loci. If this number is
not reached (or no relationships are known), the default error rate of 0.01 is
used. The minimum estimated error rate is 0.005. 
.TP
.BI --femmaxdist " f"      
Maximal distance of sampling locations for females. This is the maximal
allowed distance between mother and offspring. 
.TP
.BI --malemaxdist " f"
The same for males (candidate fathers). For individuals with unknown sex, the
maximum of the both distances are used (and unlimited if only one is specified).
.TP
.BI --parentsmaxdist " f"
And the maximal distance between mother and father.
.TP
.BI --sibmaxdist " f"
And the same for siblings. 
.PP
.B Fullsib Options:
.TP
.B --[no]fullsibtest      
Detect siblings. This turns our fullsib heuristic as described in [RSK09] on
or off (default --nofullsibtest).
.TP
.B --fullsibparental 
Detect fullsibs also in parental generation? 
.TP
.BI --fullsibpvmethod " i"
The p-Value correction method for multiple testing. 1 = Benjamini-Hochberg,
2 = Holm. Default 1.
.TP
.BI --fullsibpvth " f,f,f"   
The p-Value threshold of the sibling filter. For 0, 1 or 2 common
"compatible parental genotypes". Such sampled genotypes are compatible to an offspring
genotype according the Mendelian laws and the typing error rate.  Default is
0.001,0.005,0.05. This means that if individual A and B have no common
compatible parental genotypes, a threshold of 0.001 is used. The idea
behind these different thresholds is that if A and B have a common compatible
parent pair, this is an additional hint that A and B are fullsibs. So we
should use a less conservative p-Value threshold (0.05).
.TP
.BI --fullsibH0 " i,i,i"
Defines the null hypotheses (PO,HS,U). Examples:
.RS
.TP
0,0,1 : FS vs. Unrelated.
.TP
1,2,1*: FS vs. PO, 2xHS(HS,Aunt/Uncle), U.
.TP
2,4,1#: FS vs. 2xPO (PO and OP),4xHS(HS,Aunt/Uncle,Grandparent/-child), U.
.PP
*:default with age data, #: default without age data
.RE
.PP
.B Allele frequency Options:
.TP
.BI --freqin " FILE"
Filename of allele frequency input file (optional).
Requires --noupdatefreqs (see below).
.TP
.BI  --[no]updatefreqs
Update Allele Frequencies (default --noupdatefreqs). When turned off,
individuals are treated as unrelated and all genotypes are used to estimate
the population allele frequencies. This is a reasonable assumption when the
dataset is large and the average family size is small. Turned on, the allele
frequencies are updated by using only the founders (indegree 0 and 1).  In the
MH iterations, the frequencies are updated after a swap event (for technical
reasons). 
.PP
.B Simulation Options:
.TP
.BI --simiter " i"
Number of simulation iterations (default 25000)
.TP 
.BI --proportiontyped  " f"
Proportion of typed loci (default auto)
.TP
.BI --simselfingrate " f"
Proportion of self-fertilization. Requires --selfing. If not specified, then
the selfing rate estimated from observed average loss of heterozygosity is
used in the simulations. You can use third party software to find better
estimates (see section DATA CONVERSION).
.PP
.B HWE exact test options:
.TP
.BI --hwesteps " i"
Number of steps (default 2000) [GT92].
.TP
.BI --hwechunks " i"
Number of chunks (default 200) [GT92].
.TP
.B --hwechunksize " i"
The chunk size (default 1000) [GT92].
.PP
.B Pedigree Constraints:
.TP
.BI --maxdepth " i"
Max. pedigree depth (generations). Rejects pedigrees with a larger depth in
the Markov Chain Monte Carlo (MCMC) sampling. Without age data and if there
are many undetected fullsibs, this CAN improve the accuracy by preventing deep
"fullsib cascades" (see Fig. 1a in [RSK09]). But use with care. EXPERIMENTAL
FEATURE. 
.PP
.B MCMC Parameters:
.TP 
.BI --[no]gibbsmissing   
Gibbs sampling of missing data (default --nogibbsmissing). Roughly spoken, FRANz
can fill missing data with random alleles during pedigree reconstruction. You can
turn this on and off with this flags. EXPERIMENTAL FEATURE. 
.PP
.B Simulated Annealing (SA) Parameters:
.TP
.BI --sachains " i"
Number of chains (default 2) [Alm03].
.TP
.BI --samaxiter " i"
Max. number of iterations (default 100000000) [Alm03].
.TP
.BI --sachi " f"
Initial acceptance probability (default 0.900) [Alm03].
.TP
.BI --sacstart " f"
Sets the initial temperature, thus deactivating the initial temp. calculation
--sachi. 
.TP
.BI --sabeta " f"
Neighbourhood size factor (default 3.000) [Alm03].
.TP
.BI --sadelta " f"
Increment (default 0.100) [Alm03].
.TP
.BI --saepsilon " f"
The convergence tolerance (default 0.001000) [Alm03].
.TP
.BI  --sanepsilon " i"
Convergence events (default 3) [Alm03].
.PP
.B Metropolis Hastings Parameters:
.TP
.BI --mhchains " i"
Number of chains (default number of CPU cores). When i is > 1, then we do a
MCMCMC sampling. See below.
.TP
.BI --mhburniniter " i"
Number of burnin iterations. After starting from a random pedigree
configuration, we start the normal MH algorithm but do not sample pedigrees
in this burnin phase (default 500000).
.TP
.BI --mhiter " i"
Number of iterations (default 3000000).
.TP
.BI --mhsamplefreq " i"
Sample every ith pedigree (default 10).
.TP
.BI --mhswapfreq " i"
For MCMCMC: try to swap every ith iteration (default 100). If --mhchains is
greater than 1, then we do a MCMCMC sampling (the default on a multicore CPU
if FRANz is compiled with the --enable-openmp flag).  That is, we swap the
states of a random pair of chains and accept this swap with the normal MH
acceptance function. The chains 2, ..  n are heated, where the temperature of
the ith chain is 1 / (1 + (i - 1) * T).  T is specified via --mhtemp. 

As all threads have to wait during the swapping, it is a good time to update
allele frequencies, so we do that if --updatefreqs is set.
.TP
.B --mhtemp " f"
For MCMCMC: the temperature of the MCMCMC (default 0.500). This temperature
is used to calculate the heat of the ith chain. See --mhswapfreq. 
.PP                
.B Output options:
.TP
.BI --out " FILE"
Filename of the summary output file (default summary.txt)
.TP
.BI --lociout " FILE"
Filename of the loci summary output file (default locisummary.txt)
.TP
.BI --mismatchout " FILE"
Filename of the mismatches output file (default mismatches.txt)
.TP
.BI --freqout  " FILE"
Filename of allele frequency output file.
.TP
.BI --pout " FILEPREFIX"       
Prefix of the parentage output file(s) (default parentage). A prefix is here a
filename without the filename extension (.txt, .csv, ...). The filename
extension (suffix) is determined by the output format, see below.
.TP
.BI --poutformat " i,i"
Format(s) of the parentage outfile(s). The parameter is a list of output
formats:
.RS
.TP
1: 
.NL
Most likely parentages (.csv)
.TP
2: 
.NL
All with positive LOD (.csv)
.PP
Default "1" 
.RE
.TP
.BI --simulationout " FILE"
Filename of the simulation result file (default simulation.txt)
.TP
.BI --siblingsout " FILE"
Prefix of the siblings output file (default siblings)
.TP
.BI --siblingsoutformat " i,i"
Format(s) of the siblings outfile(s). The parameter is a list of output
formats:
.RS
.TP
1:
.NL
FRANz format (.dat)
.TP
2:
.NL
Text format (.txt)
.TP
3:
.NL
CSV format (.csv)
.PP
Default "2" (Text)
.RE
.TP
.BI --pedigreeout " FILEPREFIX"
Prefix of pedigree output files (default pedigree)
.TP
.BI --pedigreeoutformat " i,i"
Format(s) of the pedigree outfile(s). The parameter is a list of output
formats:
.RS
.TP
1:
.NL
FRANz format (.dat)
.TP
2:
.NL
Graphviz format (.dot));
.TP
3:
.NL
Text format (Id Sire Dam) (.txt)
.PP
Default "1,2" (FRANz and Graphviz)
.RE
.TP
.BI --mcmclog " FILE"
Filename of MCMC log file (default mcmc.log)
.TP
.BI --hwetestout " FILE"
Filename of the detailed HWE test results. Print the output of the original
implementation [GT92] in the specified file.
.TP
.BI --missingout " FILE"
Filename of the missing data Gibbs sampler results. 
.PP
.B Data conversion options:
.TP
.BI --cervusgenotypeout  " FILE"
Output the genotypes in CERVUS (CSV) format [KTM07].
.TP
.BI --cervusoffspringout " FILE"
Output a CERVUS offspring file [KTM07].
.TP
.BI --genepopout  " FILE"
Output the genotypes in Genepop format [R07].
.TP
.BI --rmesout  " FILE"
Output the genotypes in RMES format [DPVCG07].
.PP
.B Program options:
.TP
.BI --seed " i"
seed for random numbers (default: time)
.TP
.PD 0
.B -v
.TP
.PD
.B --verbose          
increase verbosity level (standard level: 1)
.TP
.PD 0
.B -q
.TP 
.B --quiet            
quiet mode, no output except errors and warnings is generated (=verb. level 0)
.TP
.PD 0
.B -h
.TP
.PD
.B --help
the basic options
.TP
.B --helpall
show all options
.PP
.SH QUICK START
.B Input file
.PP
Although FRANz is a command line tool, it is quite user friendly once you have
your data in the input file format. This format is very similar to Migrate and
Phylip: 
.PP
1 3 / SIMPSONS
.br
7 Springfield
.br
Grampa     1 1920 ? M 110/100 200/208 ?/?
.br
Homer      1 1950 ? M 110/170 200/210 300/302
.br
Bart       1 1982 ? M 110/120 200/212 302/304
.br
Lisa       1 1980 ? F 140/170 200/218 302/306
.br
Maggie     1 1988 ? F 110/140 210/212 300/304
.br
Marge      1 1952 ? F 120/140 212/218 ?/306
.br
Flanders   1 ? ? ? 150/160 214/220 300/?
.PP

(Note: We know that this format is not as common as Excel (CSV) files, but it has
several advantages and we provide an user friendly conversion tool on our
website. See section IMPORT FROM CSV at the end of this manual.)
.PP
The first line in this file,
.PP
1 3 / SIMPSONS
.PP
says the dataset includes one sampling location and three loci. The
alleles of diploid genotypes are separated by a slash (/), and the dataset
title is "SIMPSONS".
The second line is for the first (and in this case the only) sampling
location:
.PP
7 Springfield
.PP
This means 7 genotypes in sampling location "Springfield".
Now we come to the genotypes:
.PP
Grampa     1 1920 ? M 110/100 200/208 ?/?
.PP
The first ten characters (just like in Migrate or Phylip) are a description of
the genotype or individual. If the genotype ID is shorter than 10 characters,
you have to fill the remaining characters with spaces:
.PP
Grampa     1 1920 ? M 110/100 200/208 ?/?   #VALID
.br
Grampa 1 1920 ? M 110/100 200/208 ?/?       #INVALID
.PP
Then, the next number is how often this genotype was observed. This is meant
for clonal organisms which will be supported in future versions of this tool.
The 1920 is year of birth of Grampa, ? his year of death (unknown), M his sex
(F for females and ? if unknown). The rest of the line is reserved for the 3
diploid loci.
.PP
.B First FRANz run
.PP
You might be confused after scrolling over so many options. However, most
options have good default values and you will only need to set a few of them.
Now, run FRANz with this Simpsons example file (the $ visualizes the Command
Prompt, don't type it):
.PP
 $ FRANz --Nmax 2 simpsons.dat
.PP
The leading "--" before the parameters is important! With --Nmax 2 we say that
every offspring has not more than two candidate fathers in our population - and
for parentage inference also not more than two candidate mothers. IMPORTANT:
if you have a good estimate of the number of unsampled candidate parents, use
the --N instead of the --Nmax options. See also the section FRANz RUNS FOREVER.
.PP
Now you will get a warning because you have to specify the age range in
which an individual can reproduce sexually:
.PP
 $ FRANz --Nmax 2 --femrepro 14:45 --malerepro 14:45 simpsons.dat
.PP
You can also specify that FRANz should update the allele frequencies during
Simulated Annealing (SA) optimization and Markov Chain Monte Carlo (MCMC)
sampling with the --updatefreqs option. This is a good idea here because the
dataset is quite small and we have one big family:

.PP
 $ FRANz --Nmax 2 --femrepro 14:45 --malerepro 14:45 --updatefreqs simpsons.dat
.PP
The output:
.PP
[====================]  100%  Initializing Mersenne Twister
.br
[====================]  100%  Allele Frequency Analysis                  
.br
[====================]  100%  Simulation
.br
[====================]  100%  LOD Calculation
.br
[====================]  100%  SA Optimization
.br
[====================]  100%  MCMC (Sampling)
.PP
In the first step, we initialize the random number generator (Mersenne Twister
[MN00]). After the "Allele Frequency Analysis" we simulate individuals with
known relationship. In the "LOD Calculation" step we determine all possible
(with the allowed number of mismatching loci) parent-offspring pairs and
triples. "SA Optimization" is the Simulated Annealing step that searches
efficiently for the Maximum Likelihood pedigree.  The Markov Chain Monte Carlo
sampler finally estimates the statistical significance of the parentages.
.PP
Now open the file summary.txt. You will get some summary statistics (more
detailed in locisummary.txt). The most important file is 
parentage.csv, which lists the likeliest parents of each individual:
.PP
Grampa,2,,,,,0.000000E+00,1.0000,2,0,0,0,,,<
.br
Homer,3,Grampa,2,,,-2.613851E-01,0.6662,2,0,0,1,1.366295E+00,,<
.br
 ...
.br
Flanders,2,,,,,0.000000E+00,0.9980,3,0,3,3,,,<
.PP
The most important values are the LOD scores in column 7 [MT86] and the
posterior probabilities in column 8 [NMCP01]. MCMC and SA are necessary when
individuals cannot be ordered in generations a priori. This is the case when
not all individuals have a known year of birth.  In addition, femrepro.min and
malerepro.min must be both greater than 0. If you have specified
--updatefreqs, --Nmax and/or --gibbsmissing, we have to do a MCMC sampling. In
the case of MCMC sampling, the posterior probability is simply the fraction of
sampled pedigrees with this parentage [RSK09]. For example, a posterior
probability of 1.0 (Grampa) means that in all MCMC sampled pedigrees,
this individual had the same parentage. In only 66% of all pedigrees, Grampa
was identified as father of Homer. See also section OUTPUT FILES.
.PP
.PP
The maximum likelihood pedigree is stored in our own format as pedigree.dat
and also for visualization as Graphviz dot file. You can convert this dot file
for example in a SVG file with
.PP
 $ dot -Tsvg pedigree.dot > pedigree.svg
.PP
You can use the FRANz pedigree.dat file again as input file. For example if you
know some mother-offspring relationships:
.PP
 $ FRANz --Nmax 2 --femrepro 14:45 --malerepro 14:45 --pedigreein simpsons.mothers simpsons.dat
.PP
The age fields (year of birth and death) might be confusing. This does not
necessarily mean that you have to know the exact years. You can use this
feature to order the individuals in generations if this is known a priori. For
example, you have a set of offspring and a list of candidate parents. In this
case, just build the sets by giving them a common age, for example 2001 for
offspring and 2000 for candidate parents:

.PP
.br
Grampa     1 2000 ? M 110/100 200/208 ?/?
.br
Homer      1 2000 ? M 110/170 200/210 300/302
.br
Bart       1 2001 ? M 110/120 200/212 302/304
.br
Lisa       1 2001 ? F 140/170 200/218 302/306
.br
Maggie     1 2001 ? F 110/140 210/212 300/304
.br
Marge      1 2000 ? F 120/140 212/218 ?/306
.br
Flanders   1 2000 ? ? 150/160 214/220 300/?
.PP

Then run FRANz with
.PP
$ FRANz --femrepro 1:1 --malerepro 1:1 

.SH FRANz RUNS FOREVER

The first thing you should make sure is that you really use all the prior
information you have. The most valuable information you maybe have is the age
of the individuals. You should specify this now (see above or in the reference
under "INPUT FILES, Genotypes" below). Run FRANz and you will see a huge drop in the
runtime. 
.PP
For known parent-offspring relationships, you have to input a pedigree file.
You can either create such a file by hand (see section INPUT FILES), with our
webservice (see IMPORT FROM CSV) or you can use the output file, pedigree.dat,
of a FRANz test run and remove all the wrong/unknown relationships and add the
missing ones. Again, you will find some help about the data format below in
the reference. Do not forget to rename the altered pedigree.dat (for example
in mothers.dat), otherwise FRANz will overwrite it the next time. Then start
FRANz as before, but with this pedigree file:
.PP
.BI --pedigreein " mothers.dat"
.PP
If your marker suite is not very powerful (parent-pair exclusion probabilities
< 0.95, this means the probability that a random pair of individuals in the
population has a 5% chance of having a genotype pair compatible to an
offspring genotype. See also next section), the simulated annealing and MCMC sampling might take a
very long time without the known relationships. For testing purposes, you can
control the runtime with the --sa* and mh* parameters. For example: 
.PP
.BI --sachains " 0 " --mhburnin " 10000 " --mhiter " 20000"
.PP
Will turn off the SA optimization and will only run a very short MCMC. The
progress of the SA optimization is reported in the file mcmc.log. On Linux and
Mac, you can observe the progress with: 
.PP
$ tail -f mcmc.log
.PP
If you have a good estimate of the number of breeding males and females, you
should specify this number with --N instead of using --Nmax. See section
INCOMPLETE SAMPLING.
.PP
Finally, if you expect many fullsibs in your data, then please read the section
FULLSIBS.

.SH FRANz RUNS OUT OF MEMORY
FRANz is quite memory efficient, but if your dataset is large and your marker
suite is not very powerful (see next section), then the number of possible
parent-offspring pairs and triples might explode. Again, make sure that you
use all prior knowledge you have. Then, apart from running FRANz on a modern
computer with enough RAM, you could try a smaller typing error rate or allow
fewer mismatches (check the mismatch distributions in the output file
simulations.txt to get reasonable numbers here):
.PP
.BI --typingerror " 0.01"
.BI --maxmismatching " i,i"
.PP
If you use the multi-core version of FRANz and if you have specified --Nmax or
--gibbsmissing, then every thread will have its own copy of all possible
parentages. So you could try to run FRANz on fewer cores:
.PP
$ OMP_NUM_THREADS=4; FRANz ...
.PP
Alternatively, try: 
.PP
.BI --nogibbsmissing 
.BI --N " i"
.SH POWER OF THE MARKER SUITE
When using parentage or paternity inference methods, there are typically two
central questions: First, is the sampling rate of candidate parents high
enough? A low sampling will not catch enough parentages to estimate the
parameters of interest.  Second, is the amount of genomic information high
enough to identify parent-offspring pairs and triples in the data? The number
of required marker loci mainly depends on the expected heterozygosity of each
locus. But also ecological data is very helpful, most importantly the
age of the individuals.  Especially with low sampling rates, it is often not
possible without age data to identify parent and offspring in a
parent-offspring pair. Known relationships (e.g.  mother-offspring) are also
very informative. A good knowledge about the number of unsampled candidate
mothers and fathers and knowledge of the sex of the individuals can also
reduce the required number of marker loci.
.PP
Furthermore, the family structure in the data also influences the required
genomic signal. If we cannot exclude relatives as candidate parents, we need
more loci. On the other hand, fullsibs we can exclude as parents (e.g. because
of age prior knowledge) will reduce the amount of required loci [Wan07].
.SH INCOMPLETE SAMPLING
As already stated in the previous section, the sampling rate of candidate
parents is very important for a successful application of parentage inference
methods. As all other tools out there, FRANz requires some prior knowledge
about this sampling rate for the estimation of the statistical significance of
parentages. But in contrast to most other tools, FRANz can also incorporate
the uncertainty of this sampling rate estimation in the pedigree
reconstruction. You only have to provide an upper limit of the number of
breeding individuals in the population with the --Nmax option.  And again, if
you have a good estimate of the number of breeding males and females, you
should specify this number with --N instead of using --Nmax.  Otherwise, FRANz
has to search for the true N in one (or two if the sex of individuals is
known) additional MCMC dimensions.
.SH FULLSIBS
Fullsib relationships are very informative and reduce the candidate
parents tremendously. FRANz can identify highly probable fullsibs in the data
with the --fullsibtest option. If it is very unlikely that your data contains
many fullsibs, you should not turn this on. False positives can decrease the accuracy of the
reconstruction. As we have already said, true positives can greatly enhance
the accuracy, but if there are no fullsibs, you can only loose. As an
alternative to avoid false positives, use very conservative p-Value
thresholds:
.PP
.BI --fullsibpvth " 0.0001,0.0001,0.001"
.PP
Or select the Holm instead of the Benjamini-Hochberg correction:
.PP
.BI --fullsibpvmethod " 2"
.PP
For a good choice of the p-Value cutoff, it is recommended to check the
file siblings.txt. This file also lists all rejected fullsib candidates. These
are pairs where the likelihood that they are fullsibs is higher than the
likelihoods that they are halfsib, parent-offspring or unrelated, but the
likelihood differences were not significant (i.e. did not pass the p-Value
filter). You will see that most pairs did not pass the halfsib p-Value cutoff.
If you don't expect many halfsibs (or aunts/uncles) in the data, try less conservative cutoffs.
You can even turn the halfsib test off with:
.PP
.BI --fullsibH0 " 1,0,1"
.PP
FRANz will then test every pair against the null hypotheses 
parent-offspring and unrelated. The integer numbers can be used as weighting
factor in the p-Value calculation (see OPTIONS). 
.PP
Per default, FRANz only searches in the offspring generation for fullsibs.
This means all individuals without candidate parents in the data are omitted.
You can include these individuals with the flag --fullsibparental.
.PP
If you know some fullsib or fullsib/halfsib relationships a priori (by field
observation or determined with other tools), you can also specify them
with:
.PP
.BI --fullsibin " filename"
.PP
or
.PP
.BI --halfsibin " filename"
.PP
See the INPUT FILES section for the format of this file.
.PP
FRANz tries to detect inconsistencies in the fullsib assignments: if A,B and
B,C are fullsibs, then A and C must be fullsibs, too. Another explanation
would be that either A,B or B,C are false positives. FRANz uses a simple
heuristic here: if it is unlikely that A and C are fullsibs and either A,B or
B,C are close to the p-Value cutoff, then it marks A,B (or B,C, respectively)
as false positive. Otherwise FRANz marks A,C as fullsib (these are the
"indirect" fullsibs in siblings.txt).

.SH INPUT FILES
.B Genotypes
.PP
See the Tutorial above for a description of the main genotype file. Here the
complete example:
.PP
1 3 / SIMPSONS
.br
7 Springfield
.br
Grampa     1 1920 ? M 110/100 200/208 ?/?
.br
Homer      1 1950 ? M 110/170 200/210 300/302
.br
Bart       1 1982 ? M 110/120 200/212 302/304
.br
Lisa       1 1980 ? F 140/170 200/218 302/306
.br
Maggie     1 1988 ? F 110/140 210/212 300/304
.br
Marge      1 1952 ? F 120/140 212/218 ?/306
.br
Flanders   1 ? ? ? 150/160 214/220 300/?
.PP
If you want to provide loci ids, you can add them after the first line, one
id per line (max. length 10 characters):
.PP
1 3 / SIMPSONS
.br
L1
.br
L2
.br
L3
.br
7 Springfield
.br
Grampa     1 1920 ? M 110/100 200/208 ?/?
.br
Homer      1 1950 ? M 110/170 200/210 300/302
.br
Bart       1 1982 ? M 110/120 200/212 302/304
.br
Lisa       1 1980 ? F 140/170 200/218 302/306
.br
Maggie     1 1988 ? F 110/140 210/212 300/304
.br
Marge      1 1952 ? F 120/140 212/218 ?/306
.br
Flanders   1 ? ? ? 150/160 214/220 300/?
.PP
Here it is important that at least the first locus ID is NOT a number.
Otherwise the input file parser assumes that it is the number of individuals.

.B Known relationships
.PP
Known parent-offspring relationships are defined in FRANz with a pedigree
infile. The probably simplest thing to generate one is to run FRANz once (but
see FRANz RUNS FOREVER). It outputs a pedigree file as pedigree.dat. You can
alter this file accordingly and input in a second run with the --pedigreein
argument. Example:
.PP
7
.br
    Grampa
.br
     Homer
.br
      Bart
.br
      Lisa
.br
    Maggie
.br
     Marge
.br
  Flanders
.br
     Marge      Bart
.br
     Marge      Lisa
.br
     Marge    Maggie

The first line is the number n of individuals, the next n lines are the
exactly (!) 10 characters long names or descriptions of the individuals. They
must be identical (leading or trailing whitespaces are ignored and I recommend
right aligned ids) to the ones in the genotype file. Then, the remaining lines
are the pedigree arcs in the format
.PP
    parent     child
.PP
(each again exactly 10 characters long).
.PP
Known fullsib relationships are defined with --fullsibin. 
If you know that some individuals are either fullsibs or halfsibs, you can specify a
--halfsibin file. This is useful for example in nest structered data when one or both sexes
are monogamous - if not, see [J07]. If the genotype of the monogamous parent
of the halfsib/fullsib group is known, then just specify a pedigreein file
instead of a halfsibin file.  
.PP
Example:
.PP
1
.br
3
.br
      Bart
.br      
      Lisa
.br      
    Maggie
.PP
The first line is the number of fullsib or fullsib/halfsib groups, the 3 is
the number of fullsibs in the first group and the following 3 lines contain
the ids of the individuals as in the pedigree infile.
.PP

.B Allele frequencies
.PP
The allele frequency file is a little bit complicated, but it is also
automatically generated by FRANz. If you want to use different genotypes for
the allele frequency estimation than for the pedigree reconstruction, then
run FRANz once with the allele frequency genotypes and the command line
parameters
.TP
.BI --maxmismatching " 0,0 " --noreconstruction " " --freqout " alleles.dat"
.PP
Then run FRANz with the genotypes for the pedigree reconstruction and the
command line parameter
.TP
.BI --freqin " alleles.dat"
.PP

Example file:
.PP

3
.br
7 100 170
.br
100 0.071429
.br
110 0.285714
.br
120 0.142857
.br
140 0.214286
.br
150 0.071429
.br
160 0.071429
.br
170 0.142857
.br
7 200 220
.br
200 0.285714
.br
208 0.071429
.br
210 0.142857
.br
212 0.214286
.br
214 0.071429
.br
218 0.142857
.br
220 0.071429
.br
4 300 306
.br
300 0.300000
.br
302 0.300000
.br
304 0.200000
.br
306 0.200000
.br
.PP
The first line is the number of loci (3 in this example). The second line is
for the first locus and says that there are 7 different alleles in range 100
to 170. The next 7 lines are the alleles with their frequency (space
separated).
.PP
You can also add the sampling locations, either as pairwise distances
(--geofile) or coordinates (--coordfile). In both cases, the order of the
locations must be the same as the one in the genotype file. Examples:
.PP
.B Distances 
.PP
3
.br
AcquaAzz1 0.000 0.000 1030.116
.br
AcquaAzz2 0.000 0.000 1030.116
.br
Addaia    1030.116 1030.116 0.000
.PP
.B Coordinates
.PP
3
.br
AcquaAzz  36.43 15.09
.br
AcquaAzz2 36.43 15.09
.br
Addaia    40.016 4.207
.PP
You can specify the maximum distance between mother and child, between
father and child, between mother and father and between fullsibs. See OPTIONS. 

.SH OUTPUT FILES
.B Summary
.PP
A file with a summary of the data analysis is generated as 
.I summary.txt.
Here
you will find a compact statistic about the marker suite. For every locus,
following values are printed: 
.IP \(bu
.B Number of alleles and the allele range
.IP \(bu
.B Observed and expected Heterozygosity
.IP \(bu
.B Polymorphic Information Content (PIC) [BWSD80]
.IP \(bu
.B Exclusion Probabilities [JT97, Wan07]
.IP \(bu
.B Probability of genotype identity for random individuals and siblings [WLT01]
.IP \(bu
.B Estimation of Null allele frequency [KT06].
Note that with --pedigreein, the genotypes of observed homozygote/homozygote
mismatches are incorporated in the original formula as a_i.a_n/a_j.a_n.
.IP \(bu
.B p-Value of deviation from Hardy-Weinberg-Equilibrium and its standard error [GT92].
.PP
See the references for explanations. More detailed allele frequency statistics
can be found in 
.I locisummary.txt
The following paragraph lists basically the same values, but now for the complete
marker suite (all loci combined). The exclusion probabilities are listed for
more sampling scenarios, such as n sampled siblings.
.PP
If --selfing was specified, then the selfing rate estimated from the allele
frequencies is also reported. This is only a rough estimate as it assumes that
self-fertilization is the only reason for deviations from HWE. If
--simselfingrate was not specified, then this estimation is used in the
simulations.
.PP
The "Files" section lists the paths to the input and output files.
.PP
The next sections list the settings. For a description, see above in OPTIONS.
.PP
If some genotypes are not unique, you will find a list of these in an
"identical genotypes" section. If you have specified a pedigree infile (with
arcs), then observed mismatches are also reported.
.PP
The "Simulation" section lists the critical values for the test statistics
Delta LOD, PO and HS. See [RSK09].
.PP
The "Maximum Likelihood Pedigree" section lists the log-likelihoods of the
best, the ML pedigree. Some statistics about this ML pedigree are also given.
.PP
Finally, the "MCMC" section lists some statistics of the MCMC sampling.
.PP 
.B Parentages

This file lists the likeliest parentage for each genotype or individual. 
.PP
The LOD score in column 7 is the ratio of L(H1)/L(H2), with L(H1) being the parentage in
the current line [MT86, KTM07].
.PP
Posterior is the posterior probability of the parentage in a pedigree, defined
as the probability of observing the parentage when drawing a pedigree from the
posterior distribution. This posterior distribution is generated with the
standard Metropolis-Hastings algorithm or the MCMCMC algorithm when compiled
with --enable-openmp on a multi-core CPU. The parentage in the ML pedigree is
marked with a '<' in the last column. This is not a sign of statistical significance! 
.PP
Offspring,Loci Typed,Parent 1,Loci Typed,Parent 2,Loci Typed,LOD,Posterior,Common Loci Typed,Mismatches,n_f,n_m,Pair LOD Parent 1,Pair LOD Parent 2
.br
Grampa,2,,,,,0.000000E+00,1.0000,2,0,0,0,,,<
.br
Homer,3,Grampa,2,,,-2.613851E-01,0.6662,2,0,0,1,1.366295E+00,,<
.br
Bart,3,Marge,2,Homer,3,7.354571E-01,0.8473,3,0,1,1,9.704751E-03,1.585450E+00,<
.br
Lisa,3,Marge,2,Homer,3,3.570038E+00,0.9298,3,0,1,1,1.234198E+00,1.585450E+00,<
.br
Maggie,3,Marge,2,Homer,3,1.411737E+00,0.6927,3,0,1,1,-6.734426E-01,9.081603E-01,<
.br
Marge,2,,,,,0.000000E+00,1.0000,2,0,0,1,,,<
.br
Flanders,2,,,,,0.000000E+00,0.9980,3,0,3,3,,,<
.PP
.B Pedigree
.PP
The maximum likelihood pedigree is per default stored in two formats. The first is our own format, 
.I pedigree.dat
, which is
the same as for input pedigrees (see above). The second,
.I pedigree.dot
, is a "dot" file. Dot is a
free graph drawing program and is part of the Graphviz package. See man dot for details. A
third available format is a simple text file with three columns:
.PP
        ID       SIRE        DAM
.br        
    Grampa           *          *
.br    
      Bart       Homer      Marge
.br      
      Lisa       Homer      Marge
.br
       ...
.PP
If you'd like to see support for another format, just let us know. IMPORTANT
NOTE: if you use the Maximum Likelihood pedigree to estimate parameters,
always check the parentage file. This file lists the probabilities of each arc
in the pedigree. Instead of just using the ML pedigree, one could also
incorporate the uncertainty of the pedigree reconstruction by using all
MCMC sampled pedigrees. Please contact us if you are interested here!
.PP
.B SA and MCMC
.PP
The logfile of the SA optimization is stored as 
.I mcmc.log.
This file also lists the settings of SA and MCMC. Statistics of the sampled
pedigrees are stored in mhparam.dat. 
.PP
.B Siblings
.PP
If --fullsibtest was specified on the command line, then high probable
siblings are listed in the file
.I siblings.txt.
The log-likelihood ratios (H2: unrelated) for the relationships PO (parent-offspring), FS
(full-sib), HS (half-sib) are also listed. pV are the Benjamini-Hochberg
corrected p-Values. It is possible to generate a FRANz fullsib file with the
--siblingsoutformat option. 
.PP
.B Simulation
.PP
Detailed results of the simulation are stored in 
.I simulation.txt. 
After listing the settings used in the simulation, this file lists the observed
numbers of mismatches. First for true parent-offspring pairs, then for two
unrelated randomly chosen individuals. Now for true offspring-mother-father
triples and finally for offspring-mother-unrelated triples.
.PP
For the fullsib p-Value calculation (--fullsibtest), the observed delta values
are reported. Delta Parent-Offspring for example is defined as:
.PP  
deltaPO = P(A,B|FS) - P(A,B|PO)
.PP
and is generated for A and B being fullsibs and A and B being
parent-offspring. So deltaPO should be always positive for fullsibs and always
negative for parent-offspring pairs. A p-Value of 0.05 can be interpreted as
5% off all pairs with a value larger than this delta value, say 1.4, were
parent-offspring pairs in the simulation, NOT fullsibs despite the fact that
1.4 is positive. This delta value is reported in summary.txt, section
"Simulation Results". As another example, assume a delta value of 0 that has a
corresponding p-Value of 0.11. Then we would make in 11% of all comparisons an
error if we would just look at the sign of deltaPO. The sensitivity is the
fraction of the fullsibs we would detect with the corresponding delta value.
.PP
.B HWE 
.PP
A more detail output of the HWE tests is generated when the filename is specified with
--hwetestout. This is basically the concatenated output of the original implementation
[GT92] (which we use) of all loci.
.PP
.B Missing Alleles
.PP
If --missingout is specified, then the Gibbs sampled missing alleles are
logged during the MCMC sampling and statistics how often the alleles were
observed are printed in the specified file. 
.PP
.B Mismatches
.PP
The file mismatches.txt lists for every locus the mismatches observed during
MCMC. It also lists the percentage of sampled pedigrees showing the corresponding
mismatches.

.SH IMPORT FROM CSV
In extras/input, you will find a small perl script that transforms a CSV file
in a valid input file. For example, assume this test.csv file:
.PP
Grampa,1920,?,M,110,100,200,208,?,?
.br
Homer,1950,,M,110,170,200,210,300,302
.br
Bart,1982,?,M,110,120,200,212,302,304
.PP
Now run the script with following parameters:

$ perl csv.pl --in test.csv --birth_col 1 --death_col 2 --sex_col 3 --data_col 4

The column ids start with 0.

You will find an user friendly GUI for this script on our website. 

.SH SIMULATED ANNEALING AND MCMC PARAMETERS

Setting good parameters in a MCMC experiment is an essential but,
unfortunately, not a trivial step. A very simple test is whether the outcomes
of two or more runs are equal. If the ML pedigree looks completely different
or if the posterior probabilities in parentage.csv differ significantly, you
have to fine-tune the parameters.  The Simulated Annealing optimization should
determine good parameters automatically. You should check in mcmc.log that the
initial acceptance probability is close to 1.0. If not, then you have to set
the initial temperature manually with
.PP
.BI --sacstart " c"
.PP
For example if the initial acceptance ratio is 0.6 and the starting
temperature 110, then try a starting temperature of 300. You have to play here
until you get good results. Note that with missing age data, the maximum
acceptance probability can be significantly smaller than 1.0 because steps
that introduce cycles in the pedigree are always rejected, no matter how high
the temperature is.
.PP
You might also want to increase
.PP
.BI --sabeta " n"
.PP
or decrease
.PP
.BI --sadelta " n"
.PP
to do a more exhaustive search.
.PP
For the MCMC runs, you maybe have to increase the iterations:
.PP
.BI --mhburnin " n" 
.BI --mhiter " n"
.PP
Future versions might ship with better diagnostic tools. 

.SH MISSING DATA

If an offspring lacks both alleles at a particular locus, this locus is
ignored in all LOD calculations for this offspring. The same applies for the
case that all candidate parents lack both alleles. All other missing alleles
can be filled by Gibbs sampling with the --gibbsmissing option. I recommend to
place loci with lots of missing alleles at the end of the input file. This
way, you can easily remove them (and study the influence) with the
.PP
.BI --numloci " n"
.PP
option, which effects that only the first n loci are used. The Gibbs missing
is especially useful for datasets with high exclusion probabilities, many
known relationships and datasets with only a limited number of loci with
missing alleles.  In this case, it might be also interesting to add the
command line argument
.PP
.BI --missingout " missing.txt"
.PP
which turns on logging of the sampled missing alleles during MCMC. This gives
you then for every missing value the allele probabilities. Example:
.PP
$ FRANz simpsons.dat --Nmax 2 --femrepro 15:45 --malerepro 14:45 --updatefreqs --gibbsmissing --missingout miss.txt
.PP
miss.txt:
.PP
Genotype        300     302     304     306
.br
Grampa      *0.3982  0.3032  0.1995  0.0991
.br
Grampa       0.0989  0.2004 *0.2998  0.4009
.br
Marge        0.0010  0.0025 *0.9953  0.0013
.br
Flanders     0.2504  0.2565  0.2432 *0.2498
.PP

Note that if the number of typed
loci differs between offspring and parental generations, only the intersection
is of course informative for parentage inference. However, more typed loci in
the offspring generation are informative for the fullsib calculation. The
fullsib calculation only uses loci where both alleles are genotyped.
.PP
You probably also want to adjust the 
.PP
.BI --mintyped " n"
.PP
parameter, especially when your data contains many loci with low
heterozygosity and many loci with missing data.
.PP
Genotypes with only one missing allele are ignored in the allele frequency
estimations.

.SH TYPING ERRORS
FRANz uses the error model described in [KTM07]. If some relationships are
known, it estimates the typing error as described in [MSKP98]. How FRANz now
uses this estimates depends on the number of observed relationships. With only a
low number, FRANz uses the default typing error rate of 0.01. With a medium
number, it uses the estimated average typing error over all loci and, finally,
with a high number of observed relationships it uses the estimated error rates
for every loci. The thresholds are determined with standard statistical
methods (see --typingerror). You should always check the error rate and if
necessary provide a better one with the --typingerror option. 

.SH DATA CONVERSION

If you want to compare the FRANz results with CERVUS, you can easily do that
with the --cervus... options. It is also possible to convert the FRANz input
into the Genepop [R07] file format with the --genepopout option. The --rmesout
option can be used to generate an input file for the RMES [DPVCG07] program
for selfing-rate estimations.

.SH OTHER TOOLS
See [JA03] for a comprehensive (but now slightly outdated) comparison of other
tools, for example:
.B CERVUS [MSKP98, KTM07], COLONY [Wan04], FAMOZ [GMSBK], MasterBayes [HRB06],
.B NEST [J07], Parente [CBM02], PedApp [Alm07].
.PP

.SH REFERENCES

.TP 12
[Alm03]
.NL
A. Almudevar. A simulated annealing algorithm for maximum likelihood pedigree
reconstruction. Theor Popul Biol, 63:63-75, Mar. 2003
.TP 12
[Alm07]
.NL
A. Almudevar. A graphical approach to relatedness inference. Theoretical
Population Biology, 71, 213-229. 2007.
.TP 12
[BWSD80] 
.NL
D. Botstein, R.L. White, M. Skolnick, R.W. Davis. Construction of a genetic
linkage map in man using restriction fragment length polymorphisms. Am J Hum
Genet. 32(3): 314–331, May. 1980.
.TP 12
[CBM02]
.NL
A. Cercueil, E. Bellemain, and S. Manel. PARENTE: Computer Program for
Parentage Analysis. The Journal of Heredity 93(6). 2002
.TP 12
[DPVCG07]
.NL
P. David, B. Pujol, F. Viard,V. Castella, and J. Goudet. Reliable selfing rate
estimates from imperfect population genetic data.  Mol Ecol. 2007
Jun;16(12):2474-87.
.TP 12
[GMSBK]
.NL
S. Gerber, S. Mariette, R. Streiff, C. Bodenes C, A. Kremer A Comparison of
microsatellites and amplified fragment length polymorphism markers for
parentage analysis. Molecular Ecology, 9, 1037–1048. 2000.
.TP 12
[GT92]
.NL
S.W. Guo, E.A. Thompson. Performing the exact test of Hardy-Weinberg
proportion for multiple alleles. Biometrics, 48, 2:361-72. 1992.
.TP 12
[HRB06]
.NL
J.D. Hadfield, D.S. Richardson and T. Burke.Towards unbiased parentage
assignment: combining genetic, behavioural and spatial data in a Bayesian
framework. Mol. Ecol, 15. 3715-3730. 2006.
.TP 12
[J07]
.NL
B. Jones, D. Grossman, D.C.I. Walsh, B.A. Porter, J.C. Avise and A.C. Fiumera.
Estimating Differential Reproductive Success From Nests of Related 
Individuals, With Application to a Study of the Mottled 
Sculpin, Cottus bairdi. Genetics 176: 2427–2439. 2007
.TP 12
[JA03]
.NL
A.G. Jones and W.R. Ardren. Methods of parentage analysis in natural
populations. Molecular Ecology, 2511-2523. 2003.
.TP 12
[JT97]
.NL
A. Jamieson, Taylor. Comparisons of three probability formulae for parentage
exclusion. Animal Genetics, 28, 6:397-400(4),  Dec 1997.
.TP 12
[KT06]
.NL
S.T. Kalinowski, M.L. Taper. Maximum likelihood estimation of the frequency of
null alleles at microsatellite loci.  2006.
.TP 12
[KTM07]
.NL
S.T. Kalinowski, M.L. Taper, and T.C. Marshall. Revising how the 
computer program CERVUS accommodates genotyping error increases 
success in paternity assignment. Mol. Ecol., 16:1099--1106, Mar 2007.
.TP 12
[MN00]
.NL
M. Matsumoto, T. Nishimura. Dynamic Creation of Pseudorandom Number
Generators. Monte Carlo and Quasi-Monte Carlo Methods 1998, Springer, 2000, pp
56--69. http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/DC/dgene.pdf
.TP 12
[MSKP98]
.NL 
Marshall, TC, Slate, J, Kruuk, LEB & Pemberton, JM (1998) Statistical
confidence for likelihood-based paternity inference in natural populations.
Molecular Ecology 7: 639-655. 
.TP 12
[MT86]
.NL
T.R. Meagher, E.A. Thompson. The relationship between single parent and parent
pair genetic likelihoods in genealogy reconstruction.  Theoretical Population
Biology, 29(1):87--106, Feb. 1986.
.TP 12
[NMCP01]
.NL
R. Nielsen, D.K. Mattila, P.J. Clapham, and P.J. Palsbøll.  Statistical
approaches to paternity analysis in natural populations and applications to
the North Atlantic humpback whale. Genetics, 157:1673--1682, Apr 2001.
.TP 12
[R07]
.NL
F. Roussett. GENEPOP'007: a complete re-implementation of the genepop software
for Windows and Linux. Molecular Ecology Resources, 8,1:103-106. 2007
.TP 12
[RSK09]
.NL
M. Riester, P.F.Stadler, K.Klemm. FRANz: Reconstruction of wild
multi-generation pedigrees. Bioinformatics, 2009 (in press).
.TP 12
[Wan04]
.NL
J. Wang. Sibship reconstruction from genetic data with typing errors.
Genetics. 166(4):1963-79. 2004.
.TP 12
[Wan07]
.NL
J. Wang. Parentage and sibship exclusions: higher statistical power with more
family members. Heredity, 99, 2:205-17. 2007.
.TP 12
[WLT01]
.NL
L.P. Waits, G. Luikart, P. Taberlet. Estimating the probability of identity
among genotypes in natural populations: cautions and guidelines.  Mol Ecol.
10(1):249-56, Jan. 2001.

.SH AUTHOR
.TP 18
Markus Riester
.NL
(University of Leipzig)
.TP 18
Peter F. Stadler
.NL
(University of Leipzig, University of Vienna, Santa Fe Institute)
.TP 18
Konstantin Klemm
.NL
(University of Leipzig)

.SH FEEDBACK
Any comments, questions, critics or suggestions are gratefully received. 
So please don't hesitate to contact us! We would be happy to
help. Your feedback will help us improving this software.

.SH REPORTING BUGS
If you find a bug in this software, please send a mail to
.BR markus@bioinf.uni-leipzig.de. 
If possible, please include the input files and the command line parameters.
.SH COPYRIGHT
This is free software; see the source for copying conditions. There is
NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE
